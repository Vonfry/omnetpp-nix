stages:
  - build
  - build-libs

default:
  image: nixos/nix:latest
  before_script:
    - nix-channel --add https://nixos.org/channels/nixos-20.03 nixpkgs
    - nix-channel --update
    - mkdir -p $LOCAL_NIX_STORE
    - mkdir -p /etc/nix
    - echo "substituters = https://cache.nixos.org/ file://$LOCAL_NIX_STORE" | tee -a /etc/nix/nix.conf > /dev/null
    - echo 'require-sigs = false' | tee -a /etc/nix/nix.conf > /dev/null
  after_script:
    - nix copy --to file://$LOCAL_NIX_STORE --all
  cache:
    paths:
      - .nix/

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  LOCAL_NIX_STORE: $CI_PROJECT_DIR/.nix/store

omnetpp:
  script:
    - nix-build pkgs.nix -A omnetpp
  stage: build
  only:
    - tags

inet:
  script:
    - nix-build pkgs.nix -A inet
  dependencies:
    - omnetpp
  stage: build-libs
  only:
    - tags

ops:
  script:
    - nix-build pkgs.nix -A ops
  dependencies:
    - omnetpp
  stage: build-libs
  only:
    - tags
